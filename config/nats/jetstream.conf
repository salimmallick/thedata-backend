# Operator Authorization
authorization {
    token: ${NATS_AUTH_TOKEN}
}

# JetStream Configuration
jetstream {
    store_dir: /data/jetstream
    max_mem: ${NATS_MEMORY_LIMIT}
}

# Server Configuration
server_name: $NATS_SERVER_NAME
port: 4222
http_port: 8222
debug: false
trace: false
logtime: true

# TLS Configuration
tls {
    cert_file: "/etc/nats/certs/server.crt"
    key_file: "/etc/nats/certs/server.key"
    ca_file: "/etc/nats/certs/ca.crt"
    verify: true
}

# Monitoring Configuration
http: 8222
system_account: SYS

# Clustering Configuration
cluster {
    name: thedata-cluster
    listen: 0.0.0.0:6222
    routes = [
        nats-route://nats-1:6222
    ]
}

# Logging Configuration
log_file: "/var/log/nats/nats-server.log"
pid_file: "/var/run/nats/nats-server.pid"

# Logging configuration
log_size_limit: 50MB
max_log_age: 7
max_log_backups: 5

# Security configuration
authorization {
    token: "$NATS_AUTH_TOKEN"
    timeout: 2
}

# TLS configuration
tls {
    cert_file: "/etc/nats/certs/server-cert.pem"
    key_file: "/etc/nats/certs/server-key.pem"
    ca_file: "/etc/nats/certs/ca.pem"
    verify: true
    timeout: 2
    cipher_suites: [
        "TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384",
        "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
    ]
    curve_preferences: [
        "CurveP521",
        "CurveP384"
    ]
}

# JetStream configuration
jetstream {
    store_dir: "/data/jetstream"
    max_memory_store: ${NATS_MEMORY_LIMIT}
    max_file_store: 100G
    
    # Persistence settings
    sync: "full"
    sync_interval: "1m"
    
    # Key Value Store Config
    key_value_max_size: 64KB
    
    # Stream Defaults
    max_stream_size: 5G
    max_streams: 1000
    max_consumers: 1000
    max_msgs_per_subject: 1000000
    max_bytes_per_subject: 1G
    max_age: 24h
    duplicate_window: 2m
    
    # Recovery settings
    recover_max_bytes: 1G
    recover_max_msgs: 1000000
    recover_max_age: "2h"
}

# Streaming configuration
streaming {
    store: "file"
    store_limits {
        max_channels: 10000
        max_msgs: 0
        max_bytes: 10G
        max_age: 24h
        max_subs: 1000
    }
    
    # Fault tolerance
    ft_group: "thedata"
    store_sync: true
    sync_on_flush: true
    
    # Message replay and recovery
    max_redeliveries: 3
    ack_wait: 30s
    recover_attempts: 10
    recover_interval: "30s"
}

# Monitoring configuration
http_port: 8222
system_account: "$SYS"

# Clustering configuration
cluster {
    name: "thedata-cluster"
    listen: 0.0.0.0:6222
    routes = []
    
    # Clustering TLS
    tls {
        cert_file: "/etc/nats/certs/server-cert.pem"
        key_file: "/etc/nats/certs/server-key.pem"
        ca_file: "/etc/nats/certs/ca.pem"
        verify: true
        timeout: 2
    }
    
    # Clustering behavior
    no_advertise: false
    connect_retries: 10
    cluster_advertise: "$CLUSTER_ADVERTISE"
    
    # Cluster recovery
    recover_attempts: 5
    recover_interval: "10s"
}

# Dead Letter Queue configuration
dead_letter {
    store_dir: "/data/deadletter"
    max_delivery_attempts: 5
    ttl: "7d"
    
    # Recovery settings
    recover_policy: "retry"
    recover_interval: "1m"
    max_recover_attempts: 3
}

# Rate Limiting and Resource Management
max_connections: ${NATS_MAX_CONNECTIONS}
max_subscriptions: ${NATS_MAX_SUBSCRIPTIONS}
max_control_line: 4KB
max_pending: ${NATS_MEMORY_LIMIT}
max_pending_size: ${NATS_MEMORY_LIMIT}
write_deadline: "2s"

# System Accounts
accounts {
    SYS: {
        users: [
            {user: system, password: "$SYSTEM_PASSWORD"}
        ],
        limits: {
            max_connections: 10,
            max_subscriptions: 100,
            max_payload: 1MB
        }
    }
    
    ADMIN: {
        users: [
            {user: admin, password: "$ADMIN_PASSWORD"}
        ],
        limits: {
            max_connections: 50,
            max_subscriptions: 1000,
            max_payload: 8MB
        }
    }
    
    CLIENT: {
        users: [
            {user: client, password: "$CLIENT_PASSWORD"}
        ],
        limits: {
            max_connections: ${NATS_MAX_CONNECTIONS},
            max_subscriptions: ${NATS_MAX_SUBSCRIPTIONS},
            max_payload: 8MB
        }
    }
}

system_account: SYS 